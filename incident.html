<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Incident Tracking</title>
  <link rel="stylesheet" href="css/incident.css">



</head>
<body>

  <div class="sidebar">
    <div>
      <div class="logo">
        <img src="img/LOGO.png" alt="Logo" />
        <strong>SkinBloom</strong>
      </div>
      <nav>
        <ul>
          <li><span>ğŸ </span> <a href="regulatory.html">Dashboard</a></li>
          <li><span>ğŸ”</span> <a href="audit.html">Audits</a></li>
          <li><span>âš ï¸</span> <a href="findings.html">Findings</a></li>
          <li><span>ğŸ“</span> <a href="documents.html">Documents</a></li>
          <li class="active"><span>ğŸš©</span> <a href="incident.html">Incidents</a></li>
        </ul>
      </nav>
    </div>
    <div class="user" id="userSection">
      <span>ğŸ‘¤</span>
      <div>
        <strong>Jasper John Dreo</strong>
        <small>Compliance</small>
      </div>
      <div class="logout-dropdown" id="logoutDropdown">
        <button class="logout-btn" onclick="logout()">ğŸšª Logout</button>
      </div>
    </div>
  </div>

  <div class="main-content">
    <header>
      <div>Incident Tracking</div>
      <svg class="bell-icon" viewBox="0 0 24 24">
        <path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 0 0 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 1 0-3 0v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
      </svg>
    </header>

    <div class="cards">
      <div class="card">
        <div class="card-content">
          <span>Open Incidents</span>
          <h3 id="cardOpen">0</h3>
        </div>
        <div class="card-icon-box blue">
          <img src="https://img.icons8.com/color/48/000000/error--v1.png" />
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <span>Critical Priority</span>
          <h3 id="cardCritical">0</h3>
        </div>
        <div class="card-icon-box red">
          <img src="https://img.icons8.com/color/48/000000/high-priority.png" />
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <span>In Progress</span>
          <h3 id="cardInProgress">0</h3>
        </div>
        <div class="card-icon-box yellow">
          <img src="https://img.icons8.com/color/48/000000/time-machine.png" />
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <span>Resolved</span>
          <h3 id="cardResolved">0</h3>
        </div>
        <div class="card-icon-box green">
          <img src="https://img.icons8.com/color/48/000000/checkmark--v1.png" />
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="section-header">
        <h2>Recent Incident Reports</h2>
        <div class="buttons">
          <button class="btn btn-filter">ğŸ” Filter</button>
          <button class="btn btn-reports">ğŸ“Š Reports</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Incident Type</th>
            <th>Reported Date</th>
            <th>Status</th>
            <th>Severity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="incident-table-body">
          <!-- Rows will be loaded by JavaScript -->
        </tbody>
      </table>
      </div>
  </div>
  
  <script src="notifications.js"></script>
 
  <!-- Filter Modal -->
  <div id="filterModal" class="modal" style="display: none;">
    <div class="modal-content styled-form">
      <div class="modal-header">
        <h3>ğŸ” Filter Incidents</h3>
        <button class="close-btn" type="button" onclick="closeFilterModal()">âœ•</button>
      </div>
      <form id="filterForm">
        <label>
          <span>Status</span>
          <select name="status">
            <option value="">Any</option>
            <option value="Open">Open</option>
            <option value="Investigating">Investigating</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
          </select>
        </label>
        <label>
          <span>Severity</span>
          <select name="severity">
            <option value="">Any</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </label>
        <div class="modal-buttons">
          <button type="button" class="cancel-btn" onclick="resetIncidentFilters()">Reset</button>
          <button type="submit" class="upload-btn">Apply Filters</button>
        </div>
      </form>
    </div>
    </div>
 
   <!-- View Incident Modal -->
   <div id="viewIncidentModal" class="modal" style="display: none;">
     <div class="modal-content styled-form">
       <div class="modal-header">
         <h3>ğŸ“„ Incident Details</h3>
         <button class="close-btn" type="button" onclick="closeViewModal()">âœ•</button>
       </div>
       <p><strong>Incident Type:</strong> <span id="viewIncidentType"></span></p>
       <p><strong>Date Reported:</strong> <span id="viewDateReported"></span></p>
       <p><strong>Status:</strong> <span id="viewStatus"></span></p>
       <p><strong>Severity:</strong> <span id="viewSeverity"></span></p>
       <p><strong>Department:</strong> <span id="viewDepartment"></span></p>
       <p><strong>Description:</strong> <span id="viewDescription"></span></p>
       <p><strong>Evidence:</strong> <span id="viewEvidence"></span></p>
       <div class="modal-buttons">
         <button type="button" class="cancel-btn" onclick="closeViewModal()">Close</button>
         <button type="button" class="upload-btn" id="sendToRiskBtn">Send to Risk</button>
       </div>
     </div>
   </div>
 
   <!-- Edit Status Modal -->
   <div id="editStatusModal" class="modal" style="display: none;">
     <div class="modal-content styled-form">
       <div class="modal-header">
         <h3>âœï¸ Update Incident Status</h3>
         <button class="close-btn" type="button" onclick="closeEditModal()">âœ•</button>
       </div>
       <form id="editStatusForm">
         <label>
           <span>Status</span>
           <select name="status">
             <option value="Open">Open</option>
             <option value="Investigating">Investigating</option>
             <option value="In Progress">In Progress</option>
             <option value="Resolved">Resolved</option>
           </select>
         </label>
         <div class="modal-buttons">
           <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
           <button type="submit" class="upload-btn">Save</button>
         </div>
       </form>
     </div>
   </div>
 
   <script>
    let allIncidents = [];
    let incidentFilters = { status: '', severity: '', statusMulti: [] };

    async function loadIncidents() {
      try {
        const res = await fetch("/api/incidents");
        const data = await res.json();
        allIncidents = data;
        renderIncidents();
      } catch (err) {
        console.error("Error loading incidents:", err);
      }
    }

    function applyIncidentFilters(rows) {
      return rows.filter(r => {
        const rStatus = (r.status || '').toLowerCase();
        const rSeverity = (r.severity_level || '').toLowerCase();
        const fStatus = (incidentFilters.status || '').toLowerCase();
        const fSeverity = (incidentFilters.severity || '').toLowerCase();
        const multi = incidentFilters.statusMulti || [];
        const multiOk = !multi.length || multi.includes(rStatus);
        const statusOk = !fStatus || rStatus === fStatus;
        const severityOk = !fSeverity || rSeverity === fSeverity;
        return multiOk && statusOk && severityOk;
      });
    }

    function renderIncidents() {
      const tbody = document.getElementById("incident-table-body");
      tbody.innerHTML = "";
      const filtered = applyIncidentFilters(allIncidents);
      updateCards(filtered);
      const rowsHtml = filtered.map(row => `
        <tr data-incident-id="${row.incident_id}">
          <td>${row.incident_type || 'â€”'}</td>
          <td>${row.date_reported || 'â€”'}</td>
          <td><span class="status-${(row.status || '').toLowerCase().replace(/\s+/g, '-')}">${row.status || 'â€”'}</span></td>
          <td>${row.severity_level || 'â€”'}</td>
          <td>
            <button class="action-btn view-btn">View</button>
            <button class="action-btn edit-btn" data-action="edit-status">Edit</button>
          </td>
        </tr>
      `).join('');
      tbody.innerHTML = rowsHtml;
    }

    function openCardListModal(title, items) {
      const overlay = document.createElement('div');
      overlay.className = 'modal';
      overlay.style.display = 'flex';
      const content = document.createElement('div');
      content.className = 'modal-content styled-form';
      content.style.width = '720px';
      content.innerHTML = `
        <div class="modal-header">
          <h3>${title}</h3>
          <button class="close-btn" type="button">âœ•</button>
        </div>
        <div style="max-height:80vh; overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px;">Incident Type</th>
                <th style="text-align:left; padding:8px;">Reported Date</th>
                <th style="text-align:left; padding:8px;">Status</th>
                <th style="text-align:left; padding:8px;">Severity</th>
              </tr>
            </thead>
            <tbody>
              ${items.map(it => `
                <tr>
                  <td style=\"padding:8px; border-top:1px solid #eee;\">${it.incident_type || 'â€”'}</td>
                  <td style=\"padding:8px; border-top:1px solid #eee;\">${it.date_reported || 'â€”'}</td>
                  <td style=\"padding:8px; border-top:1px solid #eee;\">${it.status || 'â€”'}</td>
                  <td style=\"padding:8px; border-top:1px solid #eee;\">${it.severity_level || 'â€”'}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      `;
      overlay.appendChild(content);
      document.body.appendChild(overlay);
      const close = () => { try { document.body.removeChild(overlay); } catch(e){} };
      content.querySelector('.close-btn').onclick = close;
      overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
      document.addEventListener('keydown', function onKey(e){ if(e.key === 'Escape') { close(); document.removeEventListener('keydown', onKey); } });
    }

    function updateCards(rows) {
      const norm = (v) => (v || '').toLowerCase();
      const statuses = rows.map(r => norm(r.status));
      const severities = rows.map(r => norm(r.severity_level));

      const counts = {
        open: statuses.filter(s => s === 'open').length,
        inProgress: statuses.filter(s => s === 'in progress' || s === 'investigating' || s === 'progress').length,
        resolved: statuses.filter(s => s === 'resolved').length,
        critical: severities.filter(s => s === 'critical').length,
      };

      const mapEls = {
        cardOpen: { count: counts.open, filter: ['open'] },
        cardInProgress: { count: counts.inProgress, filter: ['in progress','investigating','progress'] },
        cardResolved: { count: counts.resolved, filter: ['resolved'] },
        cardCritical: { count: counts.critical, filter: null },
      };

      Object.entries(mapEls).forEach(([id, cfg]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = String(cfg.count);
        const parent = el.closest('.card');
        if (!parent) return;
        parent.style.cursor = 'pointer';
        parent.onclick = () => {
          const all = rows.slice();
          const filtered = (cfg.filter && cfg.filter.length)
            ? all.filter(r => cfg.filter.includes((r.status||'').toLowerCase()))
            : all.filter(r => (r.severity_level||'').toLowerCase() === 'critical');
          openCardListModal(id.replace('card','') + ' Incidents', filtered);
        };
      });
    }

    function openFilterModal() {
      const form = document.getElementById('filterForm');
      form.status.value = incidentFilters.status;
      form.severity.value = incidentFilters.severity;
      document.getElementById('filterModal').style.display = 'flex';
    }

    function closeFilterModal() {
      document.getElementById('filterModal').style.display = 'none';
    }

    function resetIncidentFilters() {
      incidentFilters = { status: '', severity: '' };
      const form = document.getElementById('filterForm');
      form.reset();
      renderIncidents();
      closeFilterModal();
    }

    // Edit Status modal logic
    let editingIncidentId = null;

    function openEditModal(incidentId, currentStatus) {
      editingIncidentId = incidentId;
      const form = document.getElementById('editStatusForm');
      form.status.value = currentStatus || 'Open';
      document.getElementById('editStatusModal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('editStatusModal').style.display = 'none';
      editingIncidentId = null;
    }

    function closeViewModal() {
      document.getElementById('viewIncidentModal').style.display = 'none';
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadIncidents();

      document.querySelector('.btn-filter').addEventListener('click', () => {
        openFilterModal();
      });

      const filterModal = document.getElementById('filterModal');
      filterModal.addEventListener('click', (e) => {
        if (e.target === filterModal) closeFilterModal();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (filterModal.style.display === 'flex') closeFilterModal();
          if (document.getElementById('editStatusModal').style.display === 'flex') closeEditModal();
          if (document.getElementById('viewIncidentModal').style.display === 'flex') closeViewModal();
        }
      });

      document.getElementById('filterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        incidentFilters.status = form.status.value;
        incidentFilters.severity = form.severity.value;
        renderIncidents();
        closeFilterModal();
      });

      // Delegate clicks for Edit buttons
      document.getElementById('incident-table-body').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="edit-status"]');
        if (!btn) return;
        const tr = btn.closest('tr');
        const id = tr && tr.getAttribute('data-incident-id');
        const currentStatus = tr ? tr.querySelector('td:nth-child(3) span')?.textContent : 'Open';
        if (id) openEditModal(id, currentStatus);
      });

      // Submit edit status form
      document.getElementById('editStatusForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!editingIncidentId) return;
        const form = e.target;
        const newStatus = form.status.value;
        try {
          const res = await fetch(`/api/incidents/${editingIncidentId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
          });
          if (!res.ok) throw new Error('Failed to update');
          // Refresh data and re-render
          await loadIncidents();
          renderIncidents();
          closeEditModal();
        } catch (err) {
          console.error('Failed to update status:', err);
          alert('Failed to update status');
        }
      });

      // View button behavior
      document.getElementById('incident-table-body').addEventListener('click', (e) => {
        const viewBtn = e.target.closest('button.view-btn');
        if (!viewBtn) return;
        const tr = viewBtn.closest('tr');
        const id = tr && tr.getAttribute('data-incident-id');
        if (!id) return;
        const incident = allIncidents.find(x => String(x.incident_id) === String(id));
        if (!incident) return;
        document.getElementById('viewIncidentType').textContent = incident.incident_type || 'â€”';
        document.getElementById('viewDateReported').textContent = incident.date_reported || 'â€”';
        document.getElementById('viewStatus').textContent = incident.status || 'â€”';
        document.getElementById('viewSeverity').textContent = incident.severity_level || 'â€”';
        document.getElementById('viewDepartment').textContent = incident.department || 'â€”';
        document.getElementById('viewDescription').textContent = incident.description || 'â€”';
        const evSpan = document.getElementById('viewEvidence');
        if (incident.evidence) {
          evSpan.innerHTML = `<a href="/api/incidents/${incident.incident_id}/evidence">Download</a>`;
        } else {
          evSpan.textContent = 'â€”';
        }
        document.getElementById('sendToRiskBtn').onclick = async ()=>{
          try{
            const payload = {
              risk_title: (incident.incident_type || 'Incident').slice(0,200),
              dept: incident.department || 'Unassigned',
              review_date: incident.date_reported || new Date().toISOString().slice(0,10),
              tasks: []
            };
            const res = await fetch('/api/risks', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if(!res.ok) throw new Error('Failed to send');
            const created = await res.json();
            await fetch(`/api/incidents/${incident.incident_id}`, {
              method:'PUT', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({
                incident_type: incident.incident_type,
                date_reported: incident.date_reported,
                status: 'Investigating',
                severity_level: incident.severity_level,
                risk_id: created.id
              })
            });
            await loadIncidents();
            renderIncidents();
            alert('Sent to Risk Register');
            closeViewModal();
          }catch(err){
            console.error(err);
            alert('Failed to send to Risk');
          }
        };
        document.getElementById('viewIncidentModal').style.display = 'flex';
      });

      const viewModal = document.getElementById('viewIncidentModal');
      viewModal.addEventListener('click', (e) => {
        if (e.target === viewModal) closeViewModal();
      });

      // Initialize logout functionality
      initializeLogout();
    });

    // Logout functionality
    function initializeLogout() {
      const userSection = document.getElementById('userSection');
      const logoutDropdown = document.getElementById('logoutDropdown');
      
      if (userSection && logoutDropdown) {
        // Show logout dropdown on user section click
        userSection.addEventListener('click', (e) => {
          e.stopPropagation();
          logoutDropdown.classList.toggle('show');
        });
        
        // Hide logout dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!userSection.contains(e.target)) {
            logoutDropdown.classList.remove('show');
          }
        });
      }
    }

    // Logout function
    function logout() {
      // You can add any cleanup logic here (clear session, etc.)
      window.location.href = 'index.html';
    }
  </script>

</body>
</html>



